<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Capitalist Code: An Industrial Escape - Escape Room</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              pastel: {
                bg: '#FFF5E4',
                card: '#FFFFFF',
                primary: '#FFB3BA', // Red/Pink
                secondary: '#BAFFC9', // Green
                accent: '#BAE1FF', // Blue
                warning: '#FFFFBA', // Yellow
                text: '#5D5D5D'
              }
            },
            fontFamily: {
              sans: ['Nunito', 'sans-serif'],
              display: ['Fredoka', 'sans-serif'],
            }
          }
        }
      }
    </script>
    <style>
        body { background-color: #FFF5E4; color: #5D5D5D; }
        .slide-in { animation: slideIn 0.5s ease-out; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .correct-anim { animation: pulseGreen 0.5s; }
        .wrong-anim { animation: shakeRed 0.5s; }
        @keyframes pulseGreen { 0% { transform: scale(1); } 50% { transform: scale(1.05); background-color: #BAFFC9; } 100% { transform: scale(1); } }
        @keyframes shakeRed { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        
        /* Drag and Drop Styles */
        .word-chip {
            cursor: grab;
            user-select: none;
            transition: transform 0.1s;
        }
        .word-chip:active {
            cursor: grabbing;
            transform: scale(1.05);
        }
        .gap-slot {
            display: inline-block;
            min-width: 100px;
            min-height: 2.5rem;
            vertical-align: middle;
            background-color: #FFF;
            border: 2px dashed #CBD5E1;
            border-radius: 0.5rem;
            margin: 0 0.25rem;
            padding: 0.25rem;
            transition: all 0.2s;
            text-align: center;
        }
        .gap-slot.drag-over {
            background-color: #E2E8F0;
            border-color: #94A3B8;
        }
        .gap-slot.filled {
            border-style: solid;
            background-color: #F8FAFC;
        }
        .gap-slot.correct {
            border-color: #4ADE80;
            background-color: #F0FDF4;
        }
        .gap-slot.wrong {
            border-color: #F87171;
            background-color: #FEF2F2;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 bg-pastel-bg">

    

    <div id="app" class="w-full max-w-4xl ">
        <!-- Dynamic Content Will Be Injected Here -->
    </div>

    <script>
        const gameData = {"title":"The Capitalist Code: An Industrial Escape","introText":"Welcome, aspiring economists and critical thinkers! You find yourselves trapped in the remnants of a forgotten factory, a monument to industrial history. To escape, you must decipher the complex code of capitalism, from its revolutionary birth to its modern surveillance tactics. Your journey will test your knowledge of technological shifts, societal structures, exploitation, and the ethical dilemmas of progress. Solve the puzzles, unlock the truth, and find your way out before the system consumes you!","mcqSet1":[{"question":"According to the text, what is the central idea driving the advancement of history?","options":["Religious belief and spiritual enlightenment.","Technological progress and the control of resources.","Philosophical debates and artistic movements.","Political ideologies and electoral reforms."],"correctIndex":1},{"question":"What made the Middle East a strategic region after the invention of the internal combustion engine?","options":["Its rich cultural heritage.","Its abundance of oil resources.","Its strong military alliances.","Its advanced educational institutions."],"correctIndex":1},{"question":"Which invention is associated with the First Industrial Revolution?","options":["Artificial Intelligence.","The assembly line.","Robots in factories.","The steam engine."],"correctIndex":3},{"question":"What problem did robots help solve when they entered factories during the Third Industrial Revolution?","options":["Increased worker creativity.","Higher wages for all employees.","Less jobs for people, robots worked more efficiently.","Greater job security."],"correctIndex":2},{"question":"Where did the Internet originate?","options":["A university research project.","A commercial software company.","Military research during the Cold War.","A private citizen's garage."],"correctIndex":2},{"question":"Which groups constituted the Clergy and Nobility in pre-Revolutionary France?","options":["Wealthy merchants and bankers.","Peasants and farmers.","Religious officials and aristocrats.","Doctors and lawyers."],"correctIndex":2},{"question":"Who were the bourgeoisie?","options":["The poorest members of society.","A wealthy, educated minority within the Third Estate, which was the 98% of the population.","Military leaders.","The ruling monarchs."],"correctIndex":1},{"question":"What is the primary principle driving capitalism?","options":["The highest quality with the highest cost.","The highest profit with the lowest cost.","Equal distribution of wealth.","Worker ownership of the means of production."],"correctIndex":1},{"question":"Why are workers referred to as 'proletarians'?","options":["Because they are professional artists.","Because their only possession is their 'prole' (children).","Because they provide professional services.","Because they receive large profits."],"correctIndex":1},{"question":"What does Charlie Chaplin's 'Modern Times' satirize?","options":["The joy of factory work.","The destructive relationship between man and machine.","The benefits of the assembly line.","The rise of new technologies."],"correctIndex":1}],"mcqSet2":[{"question":"What is the focus of modern exploitation in 'surveillance capitalism'?","options":["Controlling physical labor.","Controlling people's data, emotions, and behavior.","Controlling natural resources.","Controlling political elections."],"correctIndex":1},{"question":"What kind of information do data brokers package and sell?","options":["Historical weather patterns.","Device ID, location, time, and interests.","Public government records.","Literary works."],"correctIndex":1},{"question":"How do companies use data collected from users for advertisements?","options":["To inform users about global news.","To strategically manipulate emotions and stimulate spending.","To provide unbiased product reviews.","To educate consumers on healthy habits."],"correctIndex":1},{"question":"What is the purpose of Trade Unions?","options":["To promote company profits.","To defend workers, negotiate better conditions, and protect rights.","To increase production quotas.","To manage stock market investments."],"correctIndex":1},{"question":"Why did some industrialists engage in philanthropy by building housing and schools for workers?","options":["They were legally required to do so.","They believed happy workers produce more, increasing profit.","They wanted to retire early.","They were forced by worker protests."],"correctIndex":1},{"question":"What is the 'Economy of Francesco' movement centered on?","options":["Promoting capitalist expansion.","Putting human dignity and environmental respect at the center.","Developing new military technologies.","Maximizing corporate earnings."],"correctIndex":1},{"question":"What is considered the only concrete freedom left for individuals in global capitalism?","options":["Where they choose to live.","Where they choose to work.","Where they choose to spend money.","Who they choose to marry."],"correctIndex":2},{"question":"What happens when science and economics advance without ethics or human knowledge?","options":["Rapid global prosperity.","Catastrophe is possible.","Universal happiness.","Technological stagnation."],"correctIndex":1},{"question":"What does the albatross symbolize in 'The Rime of the Ancient Mariner'?","options":["A lost ship.","Human ingenuity.","Nature.","A valuable treasure."],"correctIndex":2}],"matchingSet1":[{"left":"Whoever controls resources or technology","right":"gains power."},{"left":"The steam engine was first applied to","right":"textile looms."},{"left":"Fordism transformed production speed and","right":"worker roles."},{"left":"Robots solved low productivity but created new problems","right":"by replacing human jobs."},{"left":"The Internet was born from","right":"military research."},{"left":"The Third Estate included everyone else","right":"from professionals to peasants."},{"left":"The bourgeoisie founded","right":"the first factories."}],"matchingSet2":[{"left":"Capitalism is driven by the principle:","right":"‚ÄúThe highest profit with the lowest cost.‚Äù"},{"left":"Proletarians are workers whose only possession is","right":"their children."},{"left":"Alienation is when a worker feels","right":"disconnected and loses identity."},{"left":"Charlie Chaplin's 'Modern Times' used satire to show","right":"the destructive man-machine relationship."},{"left":"Surveillance capitalism controls people's","right":"data, emotions, and behavior."},{"left":"Data brokers package and sell","right":"personal data worldwide."},{"left":"Karl Marx studied how the bourgeoisie used technology to","right":"exploit workers."}],"fillGap":{"textWithPlaceholders":"History often [GAP] according to technological progress and the control of [GAP]. The invention of the internal combustion engine made oil [GAP], making the Middle East a contested region. The French Revolution saw the rise of the [GAP], who invested in new technologies, creating [GAP]. This system is driven by seeking the highest profit with the lowest [GAP]. Modern exploitation has evolved into [GAP] capitalism, controlling data rather than manual labor. Ultimately, acting without ethics can lead to [GAP].","answers":["advances","resources","essential","bourgeoisie","capitalism","cost","surveillance","catastrophe"],"distractors":["declines","wealth","optional","nobility","socialism","gain","industrial","success"]},"openQuestions":[{"question":"Discuss how the concept of 'alienation' as described in the Second Industrial Revolution might still be relevant in today's digital workplaces, even without physical assembly lines.","modelAnswer":"Even without physical assembly lines, modern workers can experience alienation through repetitive digital tasks, lack of meaningful control over their work, feeling like a cog in a large corporate machine, or being constantly monitored through surveillance capitalism, leading to psychological distress and a loss of identity."},{"question":"The text mentions that individual power in global capitalism lies in where we choose to spend money. Do you believe this is truly a significant power for change, or are individual spending choices largely ineffective against large systems? Justify your opinion.","modelAnswer":"Individual spending choices can be seen as significant power because collective consumer behavior can drive demand for ethical products, force companies to change practices, and support businesses aligned with personal values. However, some argue it's largely ineffective, as systemic issues require governmental regulation and collective action beyond individual purchasing power, and many choices are limited by availability and affordability."}]};
        const isPreview = false;
        
        let state = {
            step: 0, // 0: Intro, 1: MCQ1, 2: MCQ2, 3: Match1, 4: Match2, 5: FillGap, 6: OpenQ, 7: Success
            scores: {},
            mcq1Selections: {}, // Separate state for Set 1
            mcq2Selections: {}, // Separate state for Set 2
            currentMatchSelections: { left: null, right: null, found: [] },
            gapPlacements: {}, // { gapIndex: 'wordText' }
            openQRevealed: [false, false]
        };

        const app = document.getElementById('app');

        function render() {
            app.innerHTML = '';
            
            if (state.step === 0) renderIntro();
            else if (state.step === 1) renderMCQ(gameData.mcqSet1, 'Challenge 1: The First Test', 'mcq1Selections');
            else if (state.step === 2) renderMCQ(gameData.mcqSet2, 'Challenge 2: The Second Obstacle', 'mcq2Selections');
            else if (state.step === 3) renderMatching(gameData.matchingSet1, 'Challenge 3: Connect Concepts');
            else if (state.step === 4) renderMatching(gameData.matchingSet2, 'Challenge 4: Build Sentences');
            else if (state.step === 5) renderFillGap(gameData.fillGap, 'Challenge 5: Missing Words');
            else if (state.step === 6) renderOpenQuestions(gameData.openQuestions, 'Challenge 6: The Final Gate');
            else if (state.step === 7) renderSuccess();
        }

        // --- RENDERERS ---

        function renderIntro() {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-3xl shadow-xl p-8 text-center slide-in border-b-8 border-pastel-primary';
            div.innerHTML = `
                <h1 class="text-4xl md:text-6xl font-display font-bold text-pastel-primary mb-6">${gameData.title}</h1>
                <p class="text-xl text-gray-600 mb-8 leading-relaxed">${gameData.introText}</p>
                <button onclick="nextStep()" class="bg-pastel-primary hover:bg-red-300 text-white font-bold py-4 px-10 rounded-full text-xl transition transform hover:scale-105 shadow-md">
                    Start Adventure
                </button>
            `;
            app.appendChild(div);
        }

        function renderMCQ(questions, title, stateKey) {
            const currentSelections = state[stateKey];
            const container = document.createElement('div');
            container.className = 'bg-white rounded-3xl shadow-xl p-6 md:p-10 slide-in border-b-8 border-pastel-accent';
            
            let html = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-display font-bold text-pastel-accent">${title}</h2>
                    <span class="bg-blue-100 text-blue-600 px-4 py-1 rounded-full text-sm font-bold">${questions.length} Questions</span>
                </div>
                <div class="space-y-8">
            `;

            questions.forEach((q, idx) => {
                const isCorrect = currentSelections[idx] === q.correctIndex;
                const isSelected = currentSelections[idx] !== undefined;
                const statusClass = isSelected ? (isCorrect ? 'border-green-400 bg-green-50' : 'border-red-400 bg-red-50') : 'border-transparent';

                html += `
                    <div class="p-4 rounded-xl border-2 ${statusClass} transition-all">
                        <p class="font-bold text-lg mb-3">${idx + 1}. ${q.question}</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            ${q.options.map((opt, optIdx) => `
                                <button 
                                    onclick="handleMcqSelect('${stateKey}', ${idx}, ${optIdx})"
                                    class="text-left p-3 rounded-lg border border-gray-200 hover:bg-blue-50 transition ${currentSelections[idx] === optIdx ? 'bg-blue-100 ring-2 ring-blue-300' : ''}"
                                >
                                    ${opt}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            const allCorrect = questions.every((q, i) => currentSelections[i] === q.correctIndex);

            html += `
                </div>
                <div class="mt-8 flex justify-end gap-3">
                    <button id="checkBtn" onclick="checkMcq('${stateKey}', ${questions.length})" class="bg-pastel-accent hover:bg-blue-300 text-white font-bold py-3 px-8 rounded-full text-lg transition shadow-md ${allCorrect ? 'hidden' : ''}">
                        Check Answers
                    </button>
                    <button onclick="nextStep()" class="bg-green-400 hover:bg-green-500 text-white font-bold py-3 px-8 rounded-full text-lg transition shadow-md ${allCorrect || isPreview ? '' : 'hidden'}">
                        ${isPreview && !allCorrect ? 'Skip (Preview) ->' : 'Next Challenge ->'}
                    </button>
                </div>
            `;
            
            container.innerHTML = html;
            app.appendChild(container);
        }

        function renderMatching(pairs, title) {
            // Flatten and shuffle for display
            if (!state.shuffledLeft) {
                state.shuffledLeft = pairs.map((p, i) => ({ val: p.left, id: i })).sort(() => Math.random() - 0.5);
                state.shuffledRight = pairs.map((p, i) => ({ val: p.right, id: i })).sort(() => Math.random() - 0.5);
            }

            const container = document.createElement('div');
            container.className = 'bg-white rounded-3xl shadow-xl p-6 md:p-10 slide-in border-b-8 border-pastel-secondary';
            
            let html = `
                <h2 class="text-3xl font-display font-bold text-green-500 mb-6">${title}</h2>
                <p class="mb-4 text-gray-500">Select an item on the left, then find its match on the right.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-3">
                        <h3 class="font-bold text-center text-gray-400 mb-2">Column A</h3>
                        ${state.shuffledLeft.map(item => {
                            const isFound = state.currentMatchSelections.found.includes(item.id);
                            const isSelected = state.currentMatchSelections.left === item.id;
                            let classes = "w-full p-4 rounded-xl border-2 transition text-left cursor-pointer ";
                            if (isFound) classes += "bg-green-100 border-green-300 opacity-50 cursor-default";
                            else if (isSelected) classes += "bg-yellow-100 border-yellow-300 ring-2 ring-yellow-200 transform scale-105";
                            else classes += "bg-gray-50 border-gray-200 hover:bg-gray-100";
                            
                            return `<div onclick="handleMatchSelect('left', ${item.id})" class="${classes}">${item.val}</div>`;
                        }).join('')}
                    </div>
                    <div class="space-y-3">
                        <h3 class="font-bold text-center text-gray-400 mb-2">Column B</h3>
                        ${state.shuffledRight.map(item => {
                             const isFound = state.currentMatchSelections.found.includes(item.id);
                             const isSelected = state.currentMatchSelections.right === item.id;
                             let classes = "w-full p-4 rounded-xl border-2 transition text-left cursor-pointer ";
                             if (isFound) classes += "bg-green-100 border-green-300 opacity-50 cursor-default";
                             else if (isSelected) classes += "bg-yellow-100 border-yellow-300 ring-2 ring-yellow-200 transform scale-105";
                             else classes += "bg-gray-50 border-gray-200 hover:bg-gray-100";
                            
                            return `<div onclick="handleMatchSelect('right', ${item.id})" class="${classes}">${item.val}</div>`;
                        }).join('')}
                    </div>
                </div>
                <div class="mt-8 flex justify-end">
                    <button onclick="nextStep()" class="bg-pastel-secondary hover:bg-green-400 text-white font-bold py-3 px-8 rounded-full text-lg transition shadow-md ${state.currentMatchSelections.found.length === pairs.length || isPreview ? '' : 'hidden'}">
                        ${isPreview && state.currentMatchSelections.found.length !== pairs.length ? 'Skip (Preview) ->' : 'Proceed ->'}
                    </button>
                </div>
            `;

            container.innerHTML = html;
            app.appendChild(container);
        }

        function renderFillGap(data, title) {
            const container = document.createElement('div');
            container.className = 'bg-white rounded-3xl shadow-xl p-6 md:p-10 slide-in border-b-8 border-pastel-orange';
            
            // Available words bank (answers + distractors shuffled)
            const allWords = [...data.answers, ...(data.distractors || [])].sort();
            
            // Filter out words that are already placed in a gap
            const placedWords = Object.values(state.gapPlacements);
            const availableWords = allWords.filter(w => {
                 // Logic to allow duplicates if the same word appears multiple times
                 const totalCount = allWords.filter(aw => aw === w).length;
                 const placedCount = placedWords.filter(pw => pw === w).length;
                 return placedCount < totalCount;
            });

            // Prepare text parts
            const parts = data.textWithPlaceholders.split('[GAP]');
            
            let textHtml = '';
            parts.forEach((part, i) => {
                textHtml += `<span>${part}</span>`;
                if (i < parts.length - 1) {
                    const filledWord = state.gapPlacements[i];
                    let slotClass = 'gap-slot';
                    if (filledWord) slotClass += ' filled';
                    
                    // Check logic classes
                    if (state.gapChecked && filledWord) {
                        const isCorrect = filledWord.toLowerCase().trim() === data.answers[i].toLowerCase().trim();
                        slotClass += isCorrect ? ' correct' : ' wrong';
                    }

                    textHtml += `<span 
                        id="gap-${i}" 
                        class="${slotClass}"
                        ondrop="drop(event, ${i})" 
                        ondragover="allowDrop(event)"
                        onclick="returnWord(${i})"
                        title="${filledWord ? 'Click to remove' : ''}"
                    >${filledWord || ''}</span>`;
                }
            });
            
            // Check if all correct (for hiding/showing buttons on re-render)
            let correctCount = 0;
            const answers = data.answers;
            for(let i=0; i<answers.length; i++) {
                if (state.gapPlacements[i]?.toLowerCase().trim() === answers[i].toLowerCase().trim()) {
                    correctCount++;
                }
            }
            const allCorrect = correctCount === answers.length;

            let html = `
                <h2 class="text-3xl font-display font-bold text-orange-400 mb-6">${title}</h2>
                <p class="mb-4 text-gray-500 italic">Drag words from the bank below and drop them into the empty slots.</p>
                
                <div class="leading-loose text-lg text-justify p-6 bg-gray-50 rounded-xl border border-gray-100 mb-8" style="line-height: 2.5rem;">
                    ${textHtml}
                </div>

                <div id="wordBank" class="bg-orange-50 p-6 rounded-xl flex flex-wrap gap-3 justify-center min-h-[100px] border-2 border-orange-100 border-dashed ${allCorrect ? 'hidden' : ''}" ondrop="dropToBank(event)" ondragover="allowDrop(event)">
                    ${availableWords.map((w, idx) => `
                        <div 
                            id="word-${w}-${idx}" 
                            class="word-chip bg-white border border-orange-200 px-4 py-2 rounded-full text-gray-700 font-bold shadow-sm hover:shadow-md hover:scale-105" 
                            draggable="true" 
                            ondragstart="drag(event, '${w}')"
                        >
                            ${w}
                        </div>
                    `).join('')}
                </div>

                <div class="mt-8 flex justify-end gap-3">
                     <button id="checkGapBtn" onclick="checkGaps(${data.answers.length})" class="bg-orange-300 hover:bg-orange-400 text-white font-bold py-3 px-8 rounded-full text-lg transition shadow-md ${allCorrect ? 'hidden' : ''}">
                        Check Answers
                    </button>
                    <button id="nextGapBtn" onclick="nextStep()" class="bg-green-400 hover:bg-green-500 text-white font-bold py-3 px-8 rounded-full text-lg transition shadow-md ${allCorrect || isPreview ? '' : 'hidden'}">
                         ${isPreview && !allCorrect ? 'Skip (Preview) ->' : 'Next Challenge ->'}
                    </button>
                </div>
            `;

            container.innerHTML = html;
            app.appendChild(container);
        }

        function renderOpenQuestions(questions, title) {
            const container = document.createElement('div');
            container.className = 'bg-white rounded-3xl shadow-xl p-6 md:p-10 slide-in border-b-8 border-purple-300';
            
            let html = `
                <h2 class="text-3xl font-display font-bold text-purple-400 mb-6">${title}</h2>
                <div class="space-y-8">
            `;

            questions.forEach((q, idx) => {
                const isRevealed = state.openQRevealed[idx];
                html += `
                    <div class="bg-purple-50 p-6 rounded-2xl border border-purple-100">
                        <p class="font-bold text-lg mb-4">${idx + 1}. ${q.question}</p>
                        <textarea class="w-full p-4 rounded-xl border-2 border-purple-200 focus:border-purple-400 outline-none h-32 mb-4" placeholder="Write your answer here..."></textarea>
                        
                        <div class="${isRevealed ? '' : 'hidden'} bg-green-50 p-4 rounded-xl border border-green-200 mb-4 transition-all">
                            <p class="text-sm font-bold text-green-600 mb-1">Model Answer:</p>
                            <p class="text-gray-700 italic">${q.modelAnswer}</p>
                        </div>

                        <button onclick="revealAnswer(${idx})" class="${isRevealed ? 'hidden' : ''} bg-purple-300 text-white px-6 py-2 rounded-full font-bold hover:bg-purple-400 transition">
                            Show Answer
                        </button>
                         <button onclick="markReviewed(${idx})" class="${isRevealed && !state.openQReviewed?.[idx] ? '' : 'hidden'} bg-green-400 text-white px-6 py-2 rounded-full font-bold hover:bg-green-500 transition">
                            Got It
                        </button>
                         <span class="${state.openQReviewed?.[idx] ? '' : 'hidden'} text-green-500 font-bold ml-2">‚úì Reviewed</span>
                    </div>
                `;
            });

             const allReviewed = questions.every((q, i) => state.openQReviewed?.[i]);

            html += `
                </div>
                <div class="mt-8 flex justify-end">
                    <button onclick="nextStep()" class="bg-purple-400 hover:bg-purple-500 text-white font-bold py-3 px-8 rounded-full text-lg transition shadow-md ${allReviewed || isPreview ? '' : 'hidden'}">
                        ${isPreview && !allReviewed ? 'Skip (Preview) ->' : 'Finish Escape Room ->'}
                    </button>
                </div>
            `;

            container.innerHTML = html;
            app.appendChild(container);
        }

        function renderSuccess() {
            const container = document.createElement('div');
            container.className = 'bg-white rounded-3xl shadow-xl p-10 text-center slide-in border-b-8 border-yellow-300 max-w-2xl';
            container.innerHTML = `
                <div class="text-6xl mb-6">üéâ üèÜ üéâ</div>
                <h1 class="text-4xl md:text-5xl font-display font-bold text-yellow-500 mb-6">ESCAPE SUCCESSFUL!</h1>
                <p class="text-xl text-gray-600 mb-8 leading-relaxed">Congratulations! You have completed all challenges and unlocked the final door.</p>
                <button onclick="location.reload()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-8 rounded-full text-lg transition">
                    Play Again
                </button>
            `;
            app.appendChild(container);
        }

        // --- LOGIC ---

        function nextStep() {
            state.step++;
            state.shuffledLeft = null; // Reset matching shuffle for next set
            state.currentMatchSelections = { left: null, right: null, found: [] }; // Reset matching state
            render();
            window.scrollTo(0,0);
        }

        window.handleMcqSelect = (stateKey, qIdx, optIdx) => {
            state[stateKey][qIdx] = optIdx;
            render();
        };

        window.checkMcq = (stateKey, total) => {
             const keys = Object.keys(state[stateKey]);
             if (keys.length < total) {
                 alert("Please answer all questions before proceeding!");
                 return;
             }
             render(); // Re-render checks correctness inside the renderer
        };

        window.handleMatchSelect = (side, id) => {
            // If already found, ignore
            if (state.currentMatchSelections.found.includes(id)) return;

            // Set selection
            if (side === 'left') state.currentMatchSelections.left = id;
            if (side === 'right') state.currentMatchSelections.right = id;

            // Check match
            if (state.currentMatchSelections.left !== null && state.currentMatchSelections.right !== null) {
                const l = state.currentMatchSelections.left;
                const r = state.currentMatchSelections.right;
                
                // Since id is the index in the original array, if left ID == right ID, it's a match
                if (l === r) {
                    state.currentMatchSelections.found.push(l);
                    state.currentMatchSelections.left = null;
                    state.currentMatchSelections.right = null;
                } else {
                    // Mismatch
                    setTimeout(() => {
                        state.currentMatchSelections.left = null;
                        state.currentMatchSelections.right = null;
                        render();
                    }, 500);
                }
            }
            render();
        };

        // --- DND LOGIC ---

        window.allowDrop = (ev) => {
            ev.preventDefault();
        };

        window.drag = (ev, word) => {
            ev.dataTransfer.setData("text", word);
        };

        window.drop = (ev, gapIndex) => {
            ev.preventDefault();
            const word = ev.dataTransfer.getData("text");
            if (word) {
                // If there was already a word here, it just goes back to pool implicitly on re-render
                state.gapPlacements[gapIndex] = word;
                state.gapChecked = false; // Reset check status on change
                render();
            }
        };

        window.dropToBank = (ev) => {
            ev.preventDefault();
            // Dragging to bank logic not strictly needed if we re-render bank based on availability
            // But if we support drag FROM gap TO bank:
            // We can add logic later. For now, click-to-return handles 'Gap -> Bank'
        };

        window.returnWord = (gapIndex) => {
            if (state.gapPlacements[gapIndex]) {
                delete state.gapPlacements[gapIndex];
                state.gapChecked = false;
                render();
            }
        };
        
        window.checkGaps = (total) => {
             state.gapChecked = true;
             // Check happens in render logic to colorize
             render(); 
        }

        window.revealAnswer = (idx) => {
            state.openQRevealed[idx] = true;
            render();
        }

        window.markReviewed = (idx) => {
            if (!state.openQReviewed) state.openQReviewed = {};
            state.openQReviewed[idx] = true;
            render();
        }

        // Init
        render();
    </script>
</body>
</html>